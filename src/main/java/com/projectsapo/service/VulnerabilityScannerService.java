package com.projectsapo.service;

import com.intellij.openapi.application.ApplicationManager;
import com.intellij.openapi.components.Service;
import com.intellij.openapi.project.Project;
import com.projectsapo.client.OsvClient;
import com.projectsapo.model.OsvPackage;
import com.projectsapo.model.OsvResponse;
import com.projectsapo.model.OsvVulnerability;
import com.projectsapo.util.DependencyParser;

import java.util.List;
import java.util.Optional;
import java.util.concurrent.CompletableFuture;
import java.util.function.Consumer;

@Service(Service.Level.PROJECT)
public final class VulnerabilityScannerService {

    private final Project project;
    private final OsvClient client;

    public VulnerabilityScannerService(Project project) {
        this.project = project;
        this.client = new OsvClient();
    }

    public static VulnerabilityScannerService getInstance(Project project) {
        return project.getService(VulnerabilityScannerService.class);
    }

    public CompletableFuture<Void> scanDependencies(Consumer<ScanResult> onResult) {
        return CompletableFuture.runAsync(() -> {
            List<OsvPackage> dependencies = DependencyParser.parseDependencies(project);
            
            if (dependencies.isEmpty()) {
                return;
            }

            List<CompletableFuture<Void>> futures = dependencies.stream()
                    .map(dep -> client.checkDependency(dep.name(), dep.version(), dep.ecosystem())
                            .thenAccept(response -> {
                                boolean vulnerable = response.isPresent() && !response.get().vulns().isEmpty();
                                List<OsvVulnerability> vulns = vulnerable ? response.get().vulns() : List.of();
                                
                                ApplicationManager.getApplication().invokeLater(() -> 
                                    onResult.accept(new ScanResult(dep, vulnerable, vulns))
                                );
                            })
                            .exceptionally(ex -> {
                                // Handle error
                                return null;
                            }))
                    .toList();

            CompletableFuture.allOf(futures.toArray(new CompletableFuture<?>[0])).join();
        });
    }

    public record ScanResult(OsvPackage pkg, boolean vulnerable, List<OsvVulnerability> vulnerabilities) {}
}
